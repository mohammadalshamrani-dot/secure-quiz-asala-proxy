<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>دخول الإدارة — منصة الاختبارات</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;direction:rtl;background:#f7f7f7;margin:0;padding:0;display:flex;align-items:center;justify-content:center;height:100vh}
  .card{width:720px;max-width:95%;background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:28px}
  h1{margin:0 0 18px;font-size:28px;color:#222}
  label{display:block;margin:12px 0 6px;color:#444}
  input{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  .actions{display:flex;gap:12px;justify-content:flex-start;margin-top:18px}
  .btn{background:#b71c1c;color:#fff;padding:10px 18px;border-radius:30px;border:none;cursor:pointer}
  .btn.secondary{background:#eee;color:#222}
  .notice{margin-top:12px;color:#c00}
</style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="title">
    <h1 id="title">دخول الإدارة</h1>

    <form id="loginForm" autocomplete="on">
      <label for="username">اسم المستخدم</label>
      <input id="username" name="username" type="text" autocomplete="username" required value="Admin">

      <label for="password">كلمة المرور</label>
      <input id="password" name="password" type="password" autocomplete="current-password" required value="AaBbCc123">

      <div class="actions">
        <button type="submit" class="btn">دخول الإدارة</button>
        <button type="button" id="forgotBtn" class="btn secondary">نسيت كلمة المرور؟</button>
      </div>

      <p id="msg" class="notice" aria-live="polite"></p>
    </form>
  </main>

<script>
/*
  Minimal robust login handler:
  - Sends POST /api/auth/login with JSON
  - On success stores token in localStorage and redirects to admin page
  - On error shows message
  - This file intentionally makes NO other changes to server code.
*/

const form = document.getElementById('loginForm');
const msg = document.getElementById('msg');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  msg.textContent = '';
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;

  if(!username || !password){
    msg.textContent = 'يرجى إدخال اسم المستخدم وكلمة المرور';
    return;
  }

  try {
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ username, password })
    });

    const data = await res.json().catch(()=>({ok:false}));

    if (res.ok && data.ok && data.token) {
      // Save token for subsequent API calls
      localStorage.setItem('asz_token', data.token);
      // Optional: save user info
      if (data.me) localStorage.setItem('asz_me', JSON.stringify(data.me));
      // Redirect to admin dashboard (existing admin page). Adjust filename if yours is different.
      window.location.href = '/admin.html';
    } else {
      // provide useful feedback
      if (data && data.error) {
        if (data.error === 'NO_USER') msg.textContent = 'المستخدم غير موجود';
        else if (data.error === 'BAD_PASS') msg.textContent = 'كلمة المرور غير صحيحة';
        else if (data.error === 'NOT_APPROVED') msg.textContent = 'الحساب غير مفعل من الإدارة';
        else msg.textContent = 'خطأ في تسجيل الدخول';
      } else {
        msg.textContent = 'تعذّر الاتصال بالخادم أو بيانات غير صحيحة';
      }
      // For security, do not expose server internals
    }
  } catch (err) {
    console.error('login catch', err);
    msg.textContent = 'تعذّر الاتصال بالخادم. تحقق من الشبكة أو حاول لاحقاً.';
  }
});

document.getElementById('forgotBtn').addEventListener('click', ()=>{
  alert('ميزة تغيير كلمة المرور غير مُفعّلة هنا. تواصل مع الإدارة.');
});
</script>
</body>
</html>
