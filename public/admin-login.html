<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>لوحة الإدارة – تسجيل الدخول</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="site-header">
      <nav class="container">
        <a href="index.html" class="brand">منصة – كليات الأصالة</a>
        <ul class="nav">
          <li><a href="index.html">الرئيسية</a></li>
          <li><a href="login.html">دخول أعضاء هيئة التدريس</a></li>
          <li><a class="active" href="admin-login.html">الإدارة</a></li>
        </ul>
      </nav>
    </header>

    <main class="container">
      <section class="card">
        <h1 class="title mb-3">لوحة الإدارة</h1>
        <div id="msg" class="alert alert-info" style="display:none"></div>

        <form id="form" class="stack gap-2" autocomplete="off">
          <label>اسم المستخدم
            <input id="username" type="text" placeholder="Admin" required />
          </label>
          <label>كلمة المرور
            <input id="password" type="password" placeholder="••••••••" required />
          </label>
          <div class="row end">
            <button type="submit" class="btn btn-primary">دخول الإدارة</button>
          </div>
        </form>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container small">منصة الاختبارات القصيرة – كليات الأصالة | تطوير: د. محمد الشمراني</div>
    </footer>

    <script>
      async function postJSON(url, data) {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        return {res, data: await res.json().catch(() => ({}))};
      }

      const form = document.getElementById('form');
      const msg = document.getElementById('msg');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.style.display = 'none';

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        const {res, data} = await postJSON('/api/auth/login', { username, password });

        if (!res.ok || !data.ok) {
          msg.textContent = 'بيانات غير صحيحة';
          msg.className = 'alert alert-danger';
          msg.style.display = 'block';
          return;
        }

        // خزن التوكن
        localStorage.setItem('asz_token', data.token);

        // توجيه ذكي: إن كان مشرف -> لوحة الإدارة، غير ذلك -> الملف الشخصي
        if (data.me && data.me.is_admin) {
          window.location.href = '/admin-dashboard.html';
        } else {
          window.location.href = '/dashboard.html';
        }
      });
    </script>
  </body>
</html>
