<!doctype html><html lang="ar" dir="rtl"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>الملف الشخصي</title>
<link rel="stylesheet" href="./style.css">
</head><body>
<header class="header">
  <div class="brand"><img class="logo" src="./assets/logo-alasala.png"><div class="title">كليات الأصالة – منصة الاختبارات</div></div>
  <nav class="nav">
    <a class="navlink" href="./home.html">الرئيسية</a>
    <a class="navlink" href="./instructions.html">تعليمات سريعة</a>
    <a class="navlink" href="./contact.html">تواصل مع الإدارة</a>
    <a class="navlink" href="./admin-login.html">الإدارة</a>
  </nav>
</header>

<main class="wrapper">
  <section class="hero-card">
    <h1>الملف الشخصي</h1>
    <div class="row">
      <!-- رابط مباشر + إيقاظ في الخلفية. الإبحار سيعمل حتى لو فشل السكربت -->
      <a id="builderLink" class="btn btn-prim" href="./admin.html" target="_self" rel="noopener">منصة إنشاء الاختبارات</a>
      <button id="btnResults" class="btn">عرض النتائج</button>
    </div>
    <div id="results" style="margin-top:12px"></div>
  </section>
</main>

<footer class="footer">منصة الاختبارات القصيرة – كليات الأصالة | تطوير: د. محمد الشمراني</footer>

<script>
// إيقاظ الخادم في الخلفية فقط — لا نمنع الإبحار إطلاقًا
async function wakeServer(retries=3){
  for(let i=0;i<retries;i++){
    try{ const ac=new AbortController(); const to=setTimeout(()=>ac.abort(),3500);
      const r=await fetch('/api/health',{signal:ac.signal}); clearTimeout(to);
      if(r.ok) return true;
    }catch(e){} await new Promise(r=>setTimeout(r,900));
  } return false;
}
function H(){return {Authorization:'Bearer '+localStorage.getItem('token'),'Content-Type':'application/json'};}

// أوقظ الخادم بمجرد فتح الصفحة، لكن لا أغيّر سلوك الرابط إطلاقًا
wakeServer(4);

// النتائج (كما هي)
async function loadResults(){
  const r=await fetch('/api/my_results',{headers:H()});
  const d=await r.json(); const items=d.items||[];
  const rows=items.map((x,i)=>`<tr><td>${i+1}</td><td>${x.link_id||''}</td><td>${x.student_name||''}</td><td>${x.score}/${x.total}</td><td>${(x.meta||{}).sid||''}</td><td>${(x.meta||{}).course||''}</td><td>${(x.meta||{}).instructor||''}</td><td>${new Date(x.created_at).toLocaleString()}</td><td>${x.left_page?'خرج':''}</td></tr>`).join('');
  results.innerHTML = `<table class='table'><thead><tr><th>#</th><th>معرّف</th><th>الطالب</th><th>الدرجة</th><th>الرقم الجامعي</th><th>المقرر</th><th>المدرس</th><th>التاريخ</th><th>ملاحظة</th></tr></thead><tbody>${rows}</tbody></table>`;
}
btnResults.onclick=loadResults;
</script>
</body></html>
