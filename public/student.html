<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>منصة الاختبارات – كليات الأصالة</title>
  <link rel="stylesheet" href="style.css"/>
  <script defer src="app.js"></script>
  <script defer src="api.js"></script>
</head>
<body>
<header class="site-header">
  <div class="brand">
    <img src="assets/logo-alasala.png" alt="شعار كليات الأصالة">
    <div class="title">كليات الأصالة – كلية القانون</div>
  </div>
  <nav>
    <a href="index.html" class="nav-home">الرئيسية</a>
    <a href="instructions.html">تعليمات سريعة</a>
    <a href="contact.html">تواصل مع الإدارة</a>
    <a href="admin-login.html">إدارة</a>
  </nav>
</header>
<main class="container">

<section class="card">
  <h2>اختبار الطالب</h2>
  <div id="studentInfo" class="muted"></div>
  <section id="studentGate" class="card">
    <h3>تعليمات البدء</h3>
    <ul>
      <li>أدخل بياناتك بدقة ولن يبدأ المؤقّت إلا بعد الضغط على بدء الاختبار.</li>
      <li>عدم مغادرة الصفحة أثناء الحل؛ سيتم تسجيل الخروج إذا حدث قبل نهاية الاختبار.</li>
      <li>أدخل اسم المقرر واسم المدرس.</li>
    </ul>
    <h3>الرجاء إدخال بياناتك لبدء الاختبار</h3>
    <label>اسم المقرر
      <input type="text" id="gateCourse" required>
    </label>
    <label>اسم المدرس
      <input type="text" id="gateTeacher" required>
    </label>
    <label>الاسم الكامل
      <input type="text" id="gateName" required>
    </label>
    <label>الرقم الجامعي
      <input type="text" id="gateSid" required>
    </label>
    <button id="gateStart" class="btn primary" disabled>بدء الاختبار</button>
  </section>
  <div id="quizBox" class="quiz-box hidden">
    <div id="qText" class="q-text"></div>
    <div id="choices"></div>
    <div class="q-controls">
      <span id="timer" class="mono"></span>
      <button id="nextBtn" class="btn">التالي</button>
    </div>
  </div>
  <div id="resultBox" class="hidden">
    <h3>نتيجتك:</h3>
    <p><strong>درجة الاختبار:</strong> <span id="score"></span></p>
    <p class="muted">ملاحظة: سيتم إرسال نتيجتك إلى المدرّس تلقائيًا.</p>
  </div>
</section>

</main>
<footer class="site-footer">منصة الاختبارات القصيرة – كليات الأصالة | مطوّر: د. محمد الشمراني – 2025</footer>
<div id="splash" class="splash hidden">
  <div class="splash-inner" data-splash-upgraded="1"><img class="splash-logo" src="assets/logo-alasala.png" alt="الشعار"><div class="splash-title">منصة الاختبارات القصيرة – كليات الأصالة</div><div class="splash-dev">مطوّر: د. محمد الشمراني</div>
    <img src="assets/logo-alasala.png" alt="الشعار">
    <div>جاري التحميل...</div>
  </div>
</div>

<!-- سكربت مضمّن: يجلب الاختبار ويفعّل زر البدء ويُدير الأسئلة والنتيجة -->
<script>
(function () {
  function $(sel){ return document.querySelector(sel); }
  function normId(v){
    if(!v) return v;
    let s = String(v).trim();
    if (s.includes('&')) s = s.split('&')[0];
    if (s.includes('?')) s = s.split('?')[0];
    if (s.includes('exp=')) s = s.split('exp=')[0];
    return s.replace(/[^a-zA-Z0-9_-]/g, '');
  }
  function getId() {
    const sp = new URLSearchParams(location.search);
    let id = sp.get('id');
    if (!id) {
      const m = /id=([^&]+)/.exec(location.search);
      if (m) id = m[1];
    }
    return normId(id);
  }
  async function fetchQuiz(id) {
    const tries = [
      `/api/quiz?id=${encodeURIComponent(id)}`,
      `/api/quiz/${encodeURIComponent(id)}`
    ];
    for (const url of tries) {
      try {
        const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (r.ok) return await r.json();
      } catch (_) {}
    }
    return null;
  }
  async function postResult(payload){
    try {
      await fetch('/api/results', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    } catch(_){}
  }

  // عناصر الصفحة
  const gate = $('#studentGate');
  const btnStart = $('#gateStart');
  const inCourse = $('#gateCourse');
  const inTeacher = $('#gateTeacher');
  const inName = $('#gateName');
  const inSid = $('#gateSid');
  const quizBox = $('#quizBox');
  const qText = $('#qText');
  const choices = $('#choices');
  const nextBtn = $('#nextBtn');
  const resultBox = $('#resultBox');
  const scoreEl = $('#score');
  const timerEl = $('#timer');

  // الحالة
  let QUIZ = null;
  let i = 0;
  let score = 0;
  let perQ = 30;
  let tick = null;
  let remaining = 0;

  function renderQuestion(){
    if (!QUIZ || !QUIZ.qs || i >= QUIZ.qs.length) return finish();
    const q = QUIZ.qs[i];
    qText.textContent = q.text || '';
    choices.innerHTML = '';
    if (q.type === 'mcq' && Array.isArray(q.opts)) {
      q.opts.forEach((opt, idx)=>{
        const id = `opt_${i}_${idx}`;
        const label = document.createElement('label');
        label.className = 'choice';
        const input = document.createElement('input');
        input.type = 'radio';
        input.name = `q_${i}`;
        input.value = idx;
        input.id = id;
        const span = document.createElement('span');
        span.textContent = opt;
        label.appendChild(input);
        label.appendChild(span);
        choices.appendChild(label);
      });
    } else {
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.id = `txt_${i}`;
      inp.className = 'text-answer';
      choices.appendChild(inp);
    }
    remaining = perQ;
    updateTimer();
    clearInterval(tick);
    tick = setInterval(()=>{
      remaining--;
      updateTimer();
      if (remaining <= 0) nextBtn.click();
    }, 1000);
  }

  function updateTimer(){
    if (timerEl) timerEl.textContent = String(remaining).padStart(2,'0');
  }
  function evalCurrent(){
    const q = QUIZ.qs[i];
    if (q.type === 'mcq') {
      const checked = choices.querySelector('input[type="radio"]:checked');
      const picked = checked ? Number(checked.value) : -1;
      if (typeof q.ans === 'number' && picked === q.ans) score++;
    } else {
      const txt = (choices.querySelector('input[type="text"]')?.value || '').trim();
      if (typeof q.ans === 'string' && txt === q.ans) score++;
    }
  }
  function next(){
    evalCurrent();
    i++;
    if (i >= QUIZ.qs.length) return finish();
    renderQuestion();
  }
  async function finish(){
    clearInterval(tick);
    gate.classList.add('hidden');
    quizBox.classList.add('hidden');
    resultBox.classList.remove('hidden');
    scoreEl.textContent = `${score} / ${QUIZ.qs.length}`;
    await postResult({
      quizId: QUIZ.id,
      studentId: inSid.value.trim(),
      score: score,
      payload: {
        name: inName.value.trim(),
        course: inCourse.value.trim(),
        teacher: inTeacher.value.trim(),
        total: QUIZ.qs.length
      }
    });
  }

  async function init(){
    const id = getId();
    if (!id) return;

    QUIZ = await fetchQuiz(id);
    if (!QUIZ || !Array.isArray(QUIZ.qs) || QUIZ.qs.length === 0) {
      return;
    }
    perQ = Number(QUIZ.perQ || 30);

    // تفعيل زر البدء
    btnStart.disabled = false;
    btnStart.removeAttribute('disabled');
    btnStart.style.pointerEvents = 'auto';
    btnStart.addEventListener('click', function(){
      if (!inCourse.value.trim() || !inTeacher.value.trim() || !inName.value.trim() || !inSid.value.trim()) {
        alert('الرجاء تعبئة جميع الحقول قبل البدء.');
        return;
      }
      gate.classList.add('hidden');
      quizBox.classList.remove('hidden');
      i = 0; score = 0;
      renderQuestion();
    });

    nextBtn.addEventListener('click', next);
  }

  document.readyState === 'loading'
    ? document.addEventListener('DOMContentLoaded', init)
    : init();
})();
</script>

</body>
</html>
